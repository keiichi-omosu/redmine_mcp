# 困った時の解決方法

プログラミングを始めたばかりの方や、Redmine MCPサーバーを初めて使う方向けのトラブルシューティングガイドです。焦らず、一つずつ確認していけば必ず解決できます。

## 目次

1. [困った時はまずここから](#困った時はまずここから)
2. [セットアップで困った時](#セットアップで困った時)
3. [サーバーが動かない時](#サーバーが動かない時)
4. [APIが使えない時](#APIが使えない時)
5. [VS Codeで接続できない時](#VS-Codeで接続できない時)
6. [それでも解決しない時は](#それでも解決しない時は)

---

## 困った時はまずここから

### 🔍 問題を特定しよう

まず、どこで問題が起きているかを確認しましょう。

**ステップ1: 基本的な動作確認**
```bash
# 現在のディレクトリを確認
pwd

# プロジェクトのファイルがあるか確認
ls -la
```

期待される結果: `server.rb`、`stdio_server.rb`、`Gemfile`などのファイルが表示される

**ステップ2: Rubyが動作するか確認**
```bash
# Rubyのバージョンを確認
ruby --version
```

期待される結果: `ruby 3.3.0` (またはそれ以降のバージョン)

**ステップ3: 必要なGemがインストールされているか確認**
```bash
# Bundlerがあるか確認
bundle --version

# Gemの状態を確認
bundle check
```

---

## セットアップで困った時

### ❌ 「Ruby のバージョンが古い」と言われた時

**エラーメッセージの例:**
```
Your Ruby version is 3.1.0, but your Gemfile specified 3.3
```

**解決方法:**

**1. rbenvを使っている場合（推奨）:**
```bash
# 利用可能なRubyバージョンを確認
rbenv install --list

# Ruby 3.3.0をインストール
rbenv install 3.3.0

# このプロジェクト専用のRubyバージョンを設定
rbenv local 3.3.0

# 設定が反映されたか確認
ruby --version
```

**2. システムのRubyを使っている場合:**

**Ubuntu/Debian系の場合:**
```bash
sudo apt update
sudo apt install ruby3.3 ruby3.3-dev
```

**macOSでHomebrewを使っている場合:**
```bash
brew install ruby@3.3
```

### ❌ 「Gemがインストールできない」と言われた時

**エラーメッセージの例:**
```
An error occurred while installing [gem名]
Make sure that `gem install [gem名]` succeeds before bundling.
```

**解決方法:**

**1. 一旦クリーンアップしてやり直し:**
```bash
# 古いファイルを削除
rm -rf vendor/bundle
rm -f Gemfile.lock

# 改めてインストール
bundle install
```

**2. 開発用のツールが足りない場合（Linux）:**
```bash
# 必要なパッケージをインストール
sudo apt-get install build-essential ruby-dev
```

**3. 開発用のツールが足りない場合（macOS）:**
```bash
# Xcode Command Line Toolsをインストール
xcode-select --install
```

### ❌ 「権限がない」と言われた時

**エラーメッセージの例:**
```
Permission denied @ rb_sysopen - /usr/local/lib/ruby/gems
```

**解決方法:**
```bash
# プロジェクト内にGemをインストールするよう設定
bundle config set --local path 'vendor/bundle'

# 改めてインストール
bundle install
```

---

## サーバーが動かない時

### ❌ 「ポートが使われている」と言われた時

**エラーメッセージの例:**
```
Address already in use - bind(2) for "0.0.0.0" port 3000
```

**解決方法:**

**1. 何がそのポートを使っているか確認:**
```bash
# ポート3000を使っているプロセスを確認
lsof -i :3000
```

**2. そのプロセスを終了:**
```bash
# 表示されたPID（プロセスID）を使って終了
kill -9 [PIDの番号]

# 例: PIDが12345の場合
kill -9 12345
```

**3. 別のポートを使う:**
```bash
# ポート3001でサーバーを起動
PORT=3001 ruby server.rb
```

### ❌ 「環境変数が設定されていない」と言われた時

**エラーメッセージの例:**
```
Missing required environment variables: REDMINE_URL, REDMINE_API_KEY
```

**解決方法:**

**1. 環境変数を一時的に設定:**
```bash
# RedmineのURLとAPIキーを設定（例）
export REDMINE_URL="http://localhost:8080"
export REDMINE_API_KEY="あなたのAPIキー"

# サーバーを起動
ruby server.rb
```

**2. .envファイルを作成（推奨）:**
```bash
# .envファイルを作成
cat > .env << EOF
REDMINE_URL=http://localhost:8080
REDMINE_API_KEY=あなたのAPIキー
EOF
```

**💡 APIキーの取得方法:**
1. Redmineにログイン
2. 右上のユーザー名をクリック → 「個人設定」
3. 「APIアクセスキー」の「表示」をクリック
4. 表示されたキーをコピー

### ❌ 「Redmineに接続できない」と言われた時

**エラーメッセージの例:**
```
Connection refused - connect(2) for "localhost" port 8080
```

**解決方法:**

**1. Redmineが動いているか確認:**
```bash
# ブラウザで確認できない場合は、コマンドで確認
curl http://localhost:8080
```

期待される結果: HTMLが返される、または302リダイレクトが返される

**2. Dockerを使っている場合:**
```bash
# Redmineコンテナの状態を確認
docker-compose ps

# Redmineを起動
docker-compose up -d redmine
```

---

## APIが使えない時

### ❌ 「401 Unauthorized」エラーが出る時

**エラーメッセージの例:**
```
Redmine API呼び出しエラー: 401 - Unauthorized
```

**解決方法:**

**1. APIキーが正しいか確認:**
```bash
# 直接APIキーをテスト
curl -H "X-Redmine-API-Key: あなたのAPIキー" http://localhost:8080/issues.json
```

期待される結果: JSONデータが返される

**2. Redmine側のREST API設定を確認:**
1. Redmineに管理者でログイン
2. 「管理」→ 「設定」→ 「認証」タブ
3. 「REST APIを有効にする」にチェックが入っているか確認
4. チェックが入っていなければチェックして「保存」

**3. APIキーを再生成:**
1. Redmineの「個人設定」→ 「APIアクセスキー」
2. 「リセット」をクリック
3. 新しいキーを環境変数に設定

### ❌ チケットが取得できない時

**症状:** エラーは出ないが、チケット情報が表示されない

**解決方法:**

**1. チケットが存在するか確認:**
```bash
# ブラウザでRedmineにアクセスして、チケット番号1が存在するか確認
# または、直接APIで確認
curl -H "X-Redmine-API-Key: あなたのAPIキー" http://localhost:8080/issues/1.json
```

**2. チケット閲覧権限があるか確認:**
- そのチケットが属するプロジェクトにアクセス権限があるか
- 非公開チケットの場合、閲覧権限があるか

---

## VS Codeで接続できない時

### ❌ MCPサーバーとの通信が失敗する時

**症状:** VS CodeのMCP拡張機能でRedmineサーバーが認識されない

**解決方法:**

**1. STDIOサーバーが動作するか確認:**
```bash
# コマンドラインで直接テスト
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' | ruby stdio_server.rb
```

期待される結果: JSON形式のレスポンスが返される

**2. VS Codeの設定ファイルを確認:**

**設定ファイルの場所:** `.vscode/settings.json` または VS Codeの設定

**正しい設定例:**
```json
{
  "mcp.servers": {
    "redmine-mcp": {
      "type": "stdio",
      "command": "ruby",
      "args": ["/home/maru/ruby/redmine_mcp/stdio_server.rb"],
      "env": {
        "REDMINE_URL": "http://localhost:8080",
        "REDMINE_API_KEY": "あなたのAPIキー"
      }
    }
  }
}
```

**⚠️ 注意点:**
- `args`の部分は絶対パス（フルパス）で指定する
- 相対パス（`./stdio_server.rb`など）は使わない

**3. パスを確認:**
```bash
# 現在のディレクトリの絶対パスを確認
pwd

# stdio_server.rbの絶対パスを確認
ls -la $(pwd)/stdio_server.rb
```

**4. ファイルの実行権限を確認:**
```bash
# 実行権限を付与
chmod +x stdio_server.rb
```

### ❌ 「ツールが見つからない」と言われた時

**解決方法:**

**1. 利用可能なツールを確認:**
```bash
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | ruby stdio_server.rb
```

期待される結果: `get_redmine_ticket`ツールが含まれたレスポンス

**2. 正しいツール呼び出し形式:**
```bash
# チケット番号123を取得する例
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"get_redmine_ticket","arguments":{"ticket_id":"123"}}}' | ruby stdio_server.rb
```

---

## それでも解決しない時は

### 🔧 詳細なログを確認する

**問題の原因を詳しく調べる方法:**

**1. デバッグモードでサーバーを起動:**
```bash
# 詳細なログを出力
export LOG_LEVEL=DEBUG
ruby server.rb
```

**2. HTTPリクエストの詳細を確認:**
```bash
# REST API通信の詳細を確認
export RESTCLIENT_LOG=stdout
ruby server.rb
```

### 📝 問題報告の準備

上記の方法で解決しない場合は、以下の情報を集めて問題を報告しましょう:

**1. 環境情報:**
```bash
# システム情報を収集
echo "OS: $(uname -a)"
echo "Ruby: $(ruby --version)"
echo "Bundle: $(bundle --version)"
echo "Directory: $(pwd)"
echo "Files: $(ls -la)"
```

**2. エラーログ:**
- 表示されたエラーメッセージの全文
- エラーが発生した時にやっていた操作

**3. 設定情報:**
- 使用している設定ファイルの内容（APIキーは除く）
- 環境変数の設定

### 💬 サポートを受ける

**GitHub Issues（バグ報告・機能要望）:**
- https://github.com/keiichi-omosu/redmine_mcp/issues

**問題報告時のテンプレート:**
```
## 問題の説明
何をしようとして、どんなエラーが出たか

## 環境情報
- OS: 
- Rubyバージョン: 
- 実行したコマンド: 

## エラーメッセージ
```
ここにエラーメッセージをコピペ
```

## 試したこと
- このガイドのどの手順を試したか
- その結果どうなったか
```

---

## 💡 よくある質問（FAQ）

**Q: 「bundler: command not found」と言われます**
A: Bundlerがインストールされていません。`gem install bundler`を実行してください。

**Q: Dockerを使いたいのですが、どうすればいいですか？**
A: `docker-compose up`でRedmineとMCPサーバーを同時に起動できます。

**Q: 本番環境で使いたいのですが、注意点はありますか？**
A: APIキーを環境変数で管理し、HTTPSを使用してください。詳しくは本格的な設定ガイドを参照してください。

**Q: 他のRedmineサーバー（cloud.redmine.jpなど）でも使えますか？**
A: はい。`REDMINE_URL`を適切なURLに設定すれば使用できます。

---

## 🎯 まとめ

- 問題が起きても焦らず、一つずつ確認していく
- エラーメッセージをよく読んで、何が問題なのかを理解する
- 環境変数の設定とファイルパスの確認が重要
- 分からないことがあれば、詳細な情報を集めて質問する

プログラミング学習の過程では、こうした問題解決のスキルも身につけられます。頑張ってください！